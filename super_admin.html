<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise Gold Admin v5.1 | BestBOT</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #F4F7FA;
            --sidebar: #1D1D1F;
            --sidebar-active: #2C2C2E;
            --card: #ffffff;
            --primary: #0071E3;
            --primary-glow: rgba(0, 113, 227, 0.3);
            --success: #34C759;
            --error: #FF3B30;
            --warning: #FF9500;
            --text-main: #1D1D1F;
            --text-mute: #86868B;
            --border: rgba(0, 0, 0, 0.05);
            --radius-lg: 20px;
            --radius-md: 14px;
            --shadow: 0 8px 30px rgba(0, 0, 0, 0.04);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        body {
            background: var(--bg);
            color: var(--text-main);
            display: flex;
            min-height: 100vh;
            overflow: hidden;
        }

        /* Sidebar Glassmorphism */
        .sidebar {
            width: 280px;
            background: var(--sidebar);
            color: white;
            display: flex;
            flex-direction: column;
            padding: 24px;
            z-index: 100;
            box-shadow: 10px 0 30px rgba(0, 0, 0, 0.05);
        }

        .sidebar-header {
            margin-bottom: 40px;
            padding-left: 10px;
        }

        .sidebar-header h1 {
            font-size: 22px;
            font-weight: 800;
            letter-spacing: -1px;
            background: linear-gradient(135deg, #fff 0%, #aaa 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .sidebar-header span {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 2px;
        }

        .nav-links {
            list-style: none;
            flex: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 8px;
            color: #A1A1AA;
            font-weight: 600;
            font-size: 14px;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 15px var(--primary-glow);
        }

        .nav-icon {
            font-size: 18px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            position: relative;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .page-title h2 {
            font-size: 28px;
            font-weight: 800;
        }

        .page-title p {
            color: var(--text-mute);
            font-size: 14px;
            margin-top: 4px;
        }

        .system-status {
            display: flex;
            gap: 16px;
        }

        .status-pill {
            background: white;
            padding: 10px 18px;
            border-radius: 40px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            font-weight: 700;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .pulse {
            width: 10px;
            height: 10px;
            background: var(--success);
            border-radius: 50%;
            box-shadow: 0 0 0 0 rgba(52, 199, 89, 0.7);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(52, 199, 89, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(52, 199, 89, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(52, 199, 89, 0);
            }
        }

        /* Mobile Responsiveness */
        @media (max-width: 900px) {
            body {
                flex-direction: column;
                overflow-y: auto;
            }

            .sidebar {
                width: 100%;
                height: auto;
                padding: 15px;
                flex-direction: row;
                overflow-x: auto;
                position: sticky;
                top: 0;
                gap: 10px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }

            .sidebar-header {
                margin-bottom: 0;
                padding-left: 0;
                min-width: 150px;
            }

            .sidebar-header span {
                display: none;
            }

            .nav-links {
                display: flex;
                gap: 8px;
                flex: initial;
            }

            .nav-item {
                margin-bottom: 0;
                padding: 10px 14px;
                white-space: nowrap;
                flex-shrink: 0;
            }

            .main-content {
                padding: 20px;
            }

            .grid-kpi {
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }

            .top-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .system-status {
                width: 100%;
                overflow-x: auto;
                padding-bottom: 5px;
            }

            .theme-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 500px) {
            .grid-kpi {
                grid-template-columns: 1fr;
            }

            .card-kpi {
                padding: 20px;
            }

            .page-title h2 {
                font-size: 22px;
            }
        }

        /* Immediate Theme Switching Effects */
        body.theme-switching {
            transition: background 0.5s ease;
        }

        body.theme-winter {
            background: #e0f7fa;
        }

        body.theme-spring {
            background: #fce4ec;
        }

        body.theme-summer {
            background: #fff9c4;
        }

        body.theme-autumn {
            background: #fff3e0;
        }

        body.theme-holiday {
            background: #f3e5f5;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .content-box {
            background: white;
            border-radius: var(--radius-lg);
            padding: 32px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            margin-bottom: 30px;
        }

        /* Theme Engine UI */
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .theme-card {
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .theme-card:hover {
            border-color: var(--primary);
            background: #fafafa;
        }

        .theme-card.active {
            border-color: var(--primary);
            background: var(--primary-glow);
        }

        .theme-preview {
            height: 80px;
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
        }

        .theme-name {
            font-weight: 700;
            font-size: 14px;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            text-align: left;
            padding: 18px;
            font-size: 12px;
            color: var(--text-mute);
            background: #fafafa;
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 18px;
            font-size: 14px;
            border-bottom: 1px solid var(--border);
            font-weight: 500;
        }

        tr:hover td {
            background: #fcfcfc;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px var(--primary-glow);
        }

        .btn-outline {
            background: transparent;
            border: 1.5px solid var(--border);
            color: var(--text-main);
        }

        .btn-outline:hover {
            background: #f5f5f5;
        }

        .btn-danger {
            background: #FF3B3015;
            color: var(--error);
        }

        /* Form Controls */
        .search-wrap {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .input-pro {
            flex: 1;
            padding: 12px 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: #fdfdfd;
            font-weight: 500;
            outline: none;
            transition: 0.3s;
        }

        .input-pro:focus {
            border-color: var(--primary);
            background: white;
        }

        /* Terminal Logs */
        .terminal {
            background: #1c1c1e;
            color: #d1d1d6;
            padding: 24px;
            border-radius: 16px;
            font-family: 'SF Mono', 'Menlo', monospace;
            font-size: 13px;
            height: 400px;
            overflow-y: auto;
            line-height: 1.5;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .log-line {
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            padding: 4px 0;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h1>BestBOT Gold</h1>
            <span>Enterprise Control</span>
        </div>
        <ul class="nav-links">
            <li class="nav-item active" onclick="goTab('dashboard', this)">
                <span class="nav-icon">üìä</span> –û–±–∑–æ—Ä
            </li>
            <li class="nav-item" onclick="goTab('management', this)">
                <span class="nav-icon">üëÆ‚Äç‚ôÇÔ∏è</span> –ü–µ—Ä—Å–æ–Ω–∞–ª
            </li>
            <li class="nav-item" onclick="goTab('tickets', this)">
                <span class="nav-icon">üé´</span> –†–µ–µ—Å—Ç—Ä
            </li>
            <li class="nav-item" onclick="goTab('storage', this)">
                <span class="nav-icon">üìÇ</span> –•—Ä–∞–Ω–∏–ª–∏—â–µ
            </li>
            <li class="nav-item" onclick="goTab('system', this)">
                <span class="nav-icon">‚öôÔ∏è</span> –°–∏—Å—Ç–µ–º–∞
            </li>
        </ul>
        <div class="sidebar-footer" style="padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.05);">
            <p style="font-size: 10px; color: #555;">v5.1 Enterprise Gold Edition</p>
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div class="page-title">
                <h2 id="current-page-title">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h2>
                <p id="current-page-desc">–†–µ–∞–ª—Ç–∞–π–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ–º–∏ —É–∑–ª–∞–º–∏ —Å–∏—Å—Ç–µ–º—ã</p>
            </div>
            <div class="system-status">
                <div class="status-pill">
                    <div class="pulse"></div>
                    Core: Online
                </div>
                <div class="status-pill">
                    ‚òÅÔ∏è DB: <span id="val-db-size">--</span> MB
                </div>
                <div class="status-pill" id="active-theme-pill" style="border-color: var(--warning);">
                    üé® –¢–µ–º–∞: <b id="val-current-theme">–°—Ç–∞–Ω–¥–∞—Ä—Ç</b>
                </div>
            </div>
        </div>

        <!-- DASHBOARD PANE -->
        <div id="pane-dashboard" class="pane active">
            <div class="grid-kpi">
                <div class="card-kpi">
                    <div class="kpi-icon" style="background: #e1f5fe; color: #01579b;">üë•</div>
                    <div class="kpi-val" id="kpi-users">0</div>
                    <div class="kpi-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                </div>
                <div class="card-kpi">
                    <div class="kpi-icon" style="background: #e8f5e9; color: #1b5e20;">üìÑ</div>
                    <div class="kpi-val" id="kpi-tickets">0</div>
                    <div class="kpi-label">–û—Ç—á–µ—Ç–æ–≤ –≤—Å–µ–≥–æ</div>
                </div>
                <div class="card-kpi">
                    <div class="kpi-icon" style="background: #fff8e1; color: #f57f17;">‚≠ê</div>
                    <div class="kpi-val" id="kpi-avg">0</div>
                    <div class="kpi-label">–û—Ç—á–µ—Ç–æ–≤ / —é–∑–µ—Ä</div>
                </div>
                <div class="card-kpi">
                    <div class="kpi-icon" style="background: #f3e5f5; color: #4a148c;">‚ö°</div>
                    <div class="kpi-val" id="kpi-uptime">0h 0m</div>
                    <div class="kpi-label">Uptime –°–µ—Ä–≤–µ—Ä–∞</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
                <div class="content-box">
                    <h3 style="margin-bottom: 24px;">–î–∏–Ω–∞–º–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h3>
                    <div style="height: 300px;">
                        <canvas id="chart-activity"></canvas>
                    </div>
                </div>
                <div class="content-box">
                    <h3 style="margin-bottom: 24px;">–ü—Ä–∏—Ç–æ–∫ –∞—É–¥–∏—Ç–æ—Ä–∏–∏</h3>
                    <div style="height: 300px;">
                        <canvas id="chart-growth"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- MANAGEMENT PANE (Users) -->
        <div id="pane-management" class="pane">
            <div class="content-box">
                <div class="search-wrap">
                    <input type="text" class="input-pro" id="search-users" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ ID..."
                        onkeyup="filterT('user-body', this.value)">
                    <button class="btn btn-outline" onclick="exportData('user-body', 'users_export.csv')">üì•
                        –≠–∫—Å–ø–æ—Ä—Ç</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>TG ID</th>
                                <th>–ò–º—è</th>
                                <th>–†–∞–Ω–≥</th>
                                <th>–ë–∞–ª–ª—ã</th>
                                <th align="right">–î–µ–π—Å—Ç–≤–∏–µ</th>
                            </tr>
                        </thead>
                        <tbody id="user-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TICKETS PANE -->
        <div id="pane-tickets" class="pane">
            <div class="content-box">
                <div class="search-wrap">
                    <input type="text" class="input-pro" id="search-tickets" placeholder="–ù–æ–º–µ—Ä –±–∏–ª–µ—Ç–∞ –∏–ª–∏ –¥–∞—Ç–∞..."
                        onkeyup="filterT('ticket-body', this.value)">
                    <button class="btn btn-outline" onclick="exportData('ticket-body', 'tickets_export.csv')">üìä –û—Ç—á–µ—Ç
                        CSV</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>–ë–∏–ª–µ—Ç</th>
                                <th>‚Ññ –ó–∞–∫–ª.</th>
                                <th>–î–∞—Ç–∞</th>
                                <th>–û–ø–µ—Ä–∞—Ç–æ—Ä</th>
                                <th align="right">–î–µ–π—Å—Ç–≤–∏–µ</th>
                            </tr>
                        </thead>
                        <tbody id="ticket-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- STORAGE PANE -->
        <div id="pane-storage" class="pane">
            <div class="content-box">
                <h3>–§–∞–π–ª–æ–≤–æ–µ –æ–±–ª–∞–∫–æ (–†–µ–µ—Å—Ç—Ä—ã –∏ –ê—Ä—Ö–∏–≤—ã)</h3>
                <p style="color: var(--text-mute); margin-bottom: 20px;">–í—Å–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ ZIP-–∞—Ä—Ö–∏–≤—ã –∏
                    Excel-–≤–µ–¥–æ–º–æ—Å—Ç–∏</p>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>–ò–º—è —Ñ–∞–π–ª–∞</th>
                                <th>–†–∞–∑–º–µ—Ä</th>
                                <th>–î–∞—Ç–∞</th>
                                <th align="right">–°–∫–∞—á–∞—Ç—å</th>
                            </tr>
                        </thead>
                        <tbody id="archive-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SYSTEM PANE -->
        <div id="pane-system" class="pane">
            <div class="content-box">
                <h3 style="margin-bottom: 20px;">üé® –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã (Seasonal Engine)</h3>
                <div class="theme-grid" id="theme-selector">
                    <div class="theme-card" data-theme="default" onclick="setTheme('default')">
                        <div class="theme-preview" style="background: #F4F7FA;">‚ö™</div>
                        <div class="theme-name">–°—Ç–∞–Ω–¥–∞—Ä—Ç</div>
                    </div>
                    <div class="theme-card" data-theme="winter" onclick="setTheme('winter')">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #E0EAFC, #CFDEF3);">‚ùÑÔ∏è
                        </div>
                        <div class="theme-name">–ó–∏–º–∞</div>
                    </div>
                    <div class="theme-card" data-theme="spring" onclick="setTheme('spring')">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #a8e063, #56ab2f);">üå∏
                        </div>
                        <div class="theme-name">–í–µ—Å–Ω–∞</div>
                    </div>
                    <div class="theme-card" data-theme="summer" onclick="setTheme('summer')">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #FFB75E, #ED8F03);">‚òÄÔ∏è
                        </div>
                        <div class="theme-name">–õ–µ—Ç–æ</div>
                    </div>
                    <div class="theme-card" data-theme="autumn" onclick="setTheme('autumn')">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #e67e22, #d35400);">üçÅ
                        </div>
                        <div class="theme-name">–û—Å–µ–Ω—å</div>
                    </div>
                    <div class="theme-card" data-theme="holiday" onclick="setTheme('holiday')">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #c0392b, #8e44ad);">üéä
                        </div>
                        <div class="theme-name">–ü—Ä–∞–∑–¥–Ω–∏–∫</div>
                    </div>
                </div>
            </div>

            <div class="content-box">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>–°–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏ (Deep Trace)</h3>
                    <button class="btn btn-outline" style="padding: 6px 12px; font-size: 11px;" onclick="loadLogs()">üîÑ
                        –û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
                <div class="terminal" id="log-console">–ñ–¥—É –¥–∞–Ω–Ω—ã—Ö –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞...</div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <div class="content-box">
                    <h3>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Core</h3>
                    <div style="margin-top: 20px;">
                        <input type="password" id="cfg-token" class="input-pro"
                            style="width: 100%; margin-bottom: 12px;" placeholder="–ò–∑–º–µ–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω –±–æ—Ç–∞...">
                        <button class="btn btn-primary" style="width: 100%; justify-content: center;"
                            onclick="saveConfig()">üõ° –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                    </div>
                </div>
                <div class="content-box" style="border-color: var(--accent);">
                    <h3>–û—á–∏—Å—Ç–∫–∞ –ö—ç—à–∞ (Hard Reset)</h3>
                    <p style="color: var(--text-mute); font-size: 13px; margin: 10px 0 20px;">–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏—Ç
                        –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (–∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞)</p>
                    <button class="btn btn-primary"
                        style="width: 100%; justify-content: center; background: var(--accent);"
                        onclick="doClearCache()">üßπ –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
                </div>
                <div class="content-box" style="border-color: var(--error);">
                    <h3>–†–µ—Å—Ç–∞—Ä—Ç –°–∏—Å—Ç–µ–º—ã</h3>
                    <p style="color: var(--text-mute); font-size: 13px; margin: 10px 0 20px;">–ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
                        –ø—Ä–æ—Ü–µ—Å—Å–∞</p>
                    <button class="btn btn-danger"
                        style="width: 100%; height: 60px; justify-content: center; font-size: 16px;"
                        onclick="doRestart()">‚ö° –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const botUrl = urlParams.get('bot_url') || '';
        const API_BASE = botUrl ? `${botUrl}/api/super-admin` : '/api/super-admin';

        let charts = {};

        // Active Theme Mapping
        const themeLabels = {
            'default': '–°—Ç–∞–Ω–¥–∞—Ä—Ç ‚ö™',
            'winter': '–ó–∏–º–∞ ‚ùÑÔ∏è',
            'spring': '–í–µ—Å–Ω–∞ üå∏',
            'summer': '–õ–µ—Ç–æ ‚òÄÔ∏è',
            'autumn': '–û—Å–µ–Ω—å üçÇ',
            'holiday': '–ü—Ä–∞–∑–¥–Ω–∏–∫ üéä'
        };

        async function goTab(pane, el) {
            document.querySelectorAll('.pane').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('pane-' + pane).classList.add('active');
            el.classList.add('active');

            // Update Title
            const titles = {
                'dashboard': ['–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è', '–†–µ–∞–ª—Ç–∞–π–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥'],
                'management': ['–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–æ–º', '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤'],
                'tickets': ['–†–µ–µ—Å—Ç—Ä –∑–∞–∫–ª—é—á–µ–Ω–∏–π', '–ü–æ–∏—Å–∫ –∏ –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö'],
                'storage': ['–•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö', '–î–æ—Å—Ç—É–ø –∫ –∞—Ä—Ö–∏–≤–∞–º'],
                'system': ['–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã', '–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —Ç–µ–º—ã']
            };
            document.getElementById('current-page-title').innerText = titles[pane][0];
            document.getElementById('current-page-desc').innerText = titles[pane][1];

            refresh(pane);
        }

        async function refresh(pane) {
            const now = Date.now();
            if (pane === 'dashboard') {
                const [stats, act, grow] = await Promise.all([
                    fFetch(`${API_BASE}/stats`),
                    fFetch(`${API_BASE}/charts/activity`),
                    fFetch(`${API_BASE}/charts/growth`)
                ]);
                if (stats) renderKPI(stats);
                if (act && grow) renderCharts(act, grow);
            } else if (pane === 'management') {
                const users = await fFetch(`${API_BASE}/users`);
                if (users) renderUsers(users);
            } else if (pane === 'tickets') {
                const t = await fFetch(`${API_BASE}/tickets`);
                if (t) renderTickets(t);
            } else if (pane === 'storage') {
                const a = await fFetch(`${API_BASE}/archives`);
                if (a) renderArchives(a);
            } else if (pane === 'system') {
                loadLogs();
                const themeData = await fFetch(`${API_BASE}/system/get-theme`);
                if (themeData) markActiveTheme(themeData.theme);
            }
        }

        // Generic fetch with error handling to fix "Load failed"
        async function fFetch(url, opts = {}) {
            try {
                const res = await fetch(url, opts);
                if (!res.ok) throw new Error('HTTP Error: ' + res.status);
                return await res.json();
            } catch (e) {
                console.error('Fetch error:', e);
                notify('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º: ' + e.message, 'error');
                return null;
            }
        }

        function renderKPI(d) {
            if (!d) return;
            document.getElementById('kpi-users').innerText = d.total_users || 0;
            document.getElementById('kpi-tickets').innerText = d.total_tickets || 0;
            document.getElementById('kpi-avg').innerText = d.avg_tickets || 0;
        }

        function renderUsers(d) {
            if (!d) return;
            document.getElementById('user-body').innerHTML = d.map(u => `
                <tr>
                    <td><code>${u.user_id}</code></td>
                    <td><b>${u.first_name || '–°–æ—Ç—Ä—É–¥–Ω–∏–∫'}</b></td>
                    <td><span class="status-pill">${u.rank || '–ù–æ–≤–∏—á–æ–∫'}</span></td>
                    <td>${u.points || 0} –±–∞–ª–ª–æ–≤</td>
                    <td align="right"><button class="btn btn-danger" style="padding:4px 10px;" onclick="killUser(${u.user_id})">üóëÔ∏è</button></td>
                </tr>
            `).join('');
        }

        function renderTickets(d) {
            if (!d) return;
            document.getElementById('ticket-body').innerHTML = d.map(t => `
                <tr>
                    <td><code>${t.ticket}</code></td>
                    <td><b>#${t.issue || '???'}</b></td>
                    <td>${t.date || '---'}</td>
                    <td>${t.user_id || '---'}</td>
                    <td align="right"><button class="btn btn-danger" style="padding:4px 10px;" onclick="killTicket('${t.ticket}')">üóëÔ∏è</button></td>
                </tr>
            `).join('');
        }

        function renderArchives(d) {
            if (!d) return;
            document.getElementById('archive-body').innerHTML = d.map(a => `
                <tr>
                    <td><b>${a.name}</b></td>
                    <td>${(a.size / 1024 / 1024).toFixed(2)} MB</td>
                    <td>${new Date(a.mtime * 1000).toLocaleDateString()}</td>
                    <td align="right"><a href="${API_BASE}/archives/download?file=${a.path}" class="btn btn-outline" style="text-decoration:none">‚¨áÔ∏è</a></td>
                </tr>
            `).join('');
        }

        function markActiveTheme(theme) {
            if (!theme) theme = 'default';
            document.querySelectorAll('.theme-card').forEach(c => {
                c.classList.toggle('active', c.dataset.theme === theme);
            });
            document.getElementById('val-current-theme').innerText = themeLabels[theme] || theme;

            // Immediate feedback: apply theme class to body
            document.body.className = document.body.className.replace(/\btheme-\S+/g, '');
            document.body.classList.add('theme-switching');
            document.body.classList.add('theme-' + theme);
        }

        async function setTheme(theme) {
            const res = await fFetch(`${API_BASE}/system/set-theme`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ theme: theme })
            });
            if (res && res.status === 'ok') {
                markActiveTheme(theme);
                notify('–¢–µ–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
            } else {
                notify('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–º—ã', 'error');
            }
        }

        async function loadLogs() {
            const d = await fFetch(`${API_BASE}/logs`);
            if (d) {
                const con = document.getElementById('log-console');
                con.innerHTML = d.logs.split('\n').map(l => `<div class="log-line">${l}</div>`).join('');
                con.scrollTop = con.scrollHeight;
            }
        }

        function renderCharts(act, grow) {
            const commonOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } };

            if (charts.act) charts.act.destroy();
            charts.act = new Chart(document.getElementById('chart-activity'), {
                type: 'bar',
                data: {
                    labels: act.map(i => i.day),
                    datasets: [{ data: act.map(i => i.count), backgroundColor: '#0071E3', borderRadius: 8 }]
                },
                options: commonOptions
            });

            if (charts.grow) charts.grow.destroy();
            charts.grow = new Chart(document.getElementById('chart-growth'), {
                type: 'line',
                data: {
                    labels: grow.map(i => i.day),
                    datasets: [{ data: grow.map(i => i.total), borderColor: '#34C759', tension: 0.4, fill: true, backgroundColor: 'rgba(52, 199, 89, 0.05)' }]
                },
                options: commonOptions
            });
        }

        // Heartbeat
        setInterval(async () => {
            const h = await fFetch(`${API_BASE}/health`);
            if (h) {
                document.getElementById('val-db-size').innerText = h.db_size;
                const hh = Math.floor(h.uptime / 3600);
                const mm = Math.floor((h.uptime % 3600) / 60);
                document.getElementById('kpi-uptime').innerText = `${hh}h ${mm}m`;
            }
        }, 8000);

        function notify(msg, type) {
            const toast = document.createElement('div');
            toast.style.cssText = `position:fixed;bottom:20px;right:20px;padding:12px 24px;background:${type === 'error' ? '#ff3b30' : '#34c759'};color:white;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.2);z-index:9999;font-weight:700;animation:slideIn 0.3s ease;`;
            toast.innerText = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function filterT(id, q) {
            const rows = document.getElementById(id).getElementsByTagName('tr');
            q = q.toLowerCase();
            for (let r of rows) r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none';
        }

        function exportData(id, file) {
            const rows = Array.from(document.getElementById(id).querySelectorAll('tr'));
            const csv = rows.map(r => Array.from(r.querySelectorAll('td')).map(td => td.innerText.replace(/,/g, '')).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = file; a.click();
        }

        async function killUser(id) { if (confirm('–£–¥–∞–ª–∏—Ç—å?')) { await fFetch(`${API_BASE}/user/delete`, { method: 'POST', body: JSON.stringify({ user_id: id }), headers: { 'Content-Type': 'application/json' } }); refresh('management'); } }
        async function killTicket(n) { if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –º–µ—Ç–∫—É?')) { await fFetch(`${API_BASE}/ticket/delete`, { method: 'POST', body: JSON.stringify({ ticket_number: n }), headers: { 'Content-Type': 'application/json' } }); refresh('tickets'); } }
        async function doRestart() {
            if (!confirm('–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä?')) return;
            const res = await fFetch(`${API_BASE}/system/restart`, { method: 'POST' });
            if (res) notify('–°–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...', 'success');
        }

        async function doClearCache() {
            if (!confirm('–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?')) return;
            const res = await fFetch(`${API_BASE}/system/clear-cache`, { method: 'POST' });
            if (res && res.status === 'ok') {
                notify('–ö—ç—à —Å–±—Ä–æ—à–µ–Ω. –í–µ—Ä—Å–∏—è: ' + res.new_cv, 'success');
            } else {
                notify('–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ –∫—ç—à–∞', 'error');
            }
        }

        // Init
        goTab('dashboard', document.querySelector('.nav-item'));
    </script>
</body>

</html>